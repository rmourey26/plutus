<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- editorconfig-checker-disable-file</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns      #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE MagicHash         #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="annot"><span class="hs-comment">-- | Implementations for conversion primops from 'Integer' to 'ByteString' and back again.</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusCore.Bitwise.Convert</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-comment">-- Wrappers</span><span>
</span><span id="line-10"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringWrapper"><span class="hs-identifier">integerToByteStringWrapper</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#byteStringToIntegerWrapper"><span class="hs-identifier">byteStringToIntegerWrapper</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-comment">-- Implementation details</span><span>
</span><span id="line-13"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#IntegerToByteStringError"><span class="hs-identifier">IntegerToByteStringError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringMaximumOutputLength"><span class="hs-identifier">integerToByteStringMaximumOutputLength</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#integerToByteString"><span class="hs-identifier">integerToByteString</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#byteStringToInteger"><span class="hs-identifier">byteStringToInteger</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinResult"><span class="hs-identifier">BuiltinResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier">emit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Result.html"><span class="hs-identifier">PlutusCore.Evaluation.Result</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier">evaluationFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">ByteString.StrictBuilder</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Builder</span></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">ByteString.StrictBuilder</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Builder</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Control.Monad.html#guard"><span class="hs-identifier">guard</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Bits.html"><span class="hs-identifier">Data.Bits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-identifier">unsafeShiftL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-identifier">unsafeShiftR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator">(.|.)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pack</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word8"><span class="hs-identifier">Word8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html"><span class="hs-identifier">GHC.ByteOrder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#ByteOrder"><span class="hs-identifier">ByteOrder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#BigEndian"><span class="hs-identifier">BigEndian</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#LittleEndian"><span class="hs-identifier">LittleEndian</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Exts.html"><span class="hs-identifier">GHC.Exts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier">Int</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#I%23"><span class="hs-identifier">I#</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Integer.Logarithms.html"><span class="hs-identifier">GHC.Integer.Logarithms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Integer.Logarithms.html#integerLog2%23"><span class="hs-identifier">integerLog2#</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-comment">{- Note [Input length limitation for IntegerToByteString].  We make
   `integerToByteString` fail if it is called with arguments which would cause
   the length of the result to exceed about 8K bytes because the execution time
   becomes difficult to predict accurately beyond this point (benchmarks on a
   number of different machines show that the CPU time increases smoothly for
   inputs up to about 8K then increases sharply, becoming chaotic after about
   14K).  This restriction may be removed once a more efficient implementation
   becomes available, which may happen when we no longer have to support GHC
   8.10. -}</span><span>
</span><span id="line-43"></span><span class="hs-comment">{- NB: if we do relax the length restriction then we will need two variants of
   integerToByteString in Plutus Core so that we can continue to support the
   current behaviour for old scripts.-}</span><span>
</span><span id="line-46"></span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringMaximumOutputLength"><span class="hs-identifier hs-type">integerToByteStringMaximumOutputLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-47"></span><span id="integerToByteStringMaximumOutputLength"><span class="annot"><span class="annottext">integerToByteStringMaximumOutputLength :: Integer
</span><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringMaximumOutputLength"><span class="hs-identifier hs-var hs-var">integerToByteStringMaximumOutputLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">8192</span></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-comment">{- Return the base 2 logarithm of an integer, returning 0 for inputs that aren't
   strictly positive.  This is essentially copied from GHC.Num.Integer, which
   has integerLog2 but only in GHC &gt;= 9.0. We should use the library function
   instead when we stop supporting 8.10. -}</span><span>
</span><span id="line-53"></span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#integerLog2"><span class="hs-identifier hs-type">integerLog2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-54"></span><span id="integerLog2"><span class="annot"><span class="annottext">integerLog2 :: Integer -&gt; Int
</span><a href="PlutusCore.Bitwise.Convert.html#integerLog2"><span class="hs-identifier hs-var hs-var">integerLog2</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681576938"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576938"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int# -&gt; Int
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#I%23"><span class="hs-identifier hs-var">I#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Int#
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Integer.Logarithms.html#integerLog2%23"><span class="hs-identifier hs-var">integerLog2#</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576938"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="annot"><span class="hs-comment">-- | Wrapper for 'integerToByteString' to make it more convenient to define as a builtin.</span></span><span>
</span><span id="line-57"></span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringWrapper"><span class="hs-identifier hs-type">integerToByteStringWrapper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinResult"><span class="hs-identifier hs-type">BuiltinResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-58"></span><span id="integerToByteStringWrapper"><span class="annot"><span class="annottext">integerToByteStringWrapper :: Bool -&gt; Integer -&gt; Integer -&gt; BuiltinResult ByteString
</span><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringWrapper"><span class="hs-identifier hs-var hs-var">integerToByteStringWrapper</span></a></span></span><span> </span><span id="local-6989586621681576939"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681576939"><span class="hs-identifier hs-var">endiannessArg</span></a></span></span><span> </span><span id="local-6989586621681576940"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576940"><span class="hs-identifier hs-var">lengthArg</span></a></span></span><span> </span><span id="local-6989586621681576941"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576941"><span class="hs-identifier hs-var">input</span></a></span></span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-comment">-- Check that the length is non-negative.</span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576940"><span class="hs-identifier hs-var">lengthArg</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-61"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;integerToByteString: negative length argument&quot;</span></span><span>
</span><span id="line-62"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Length requested: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Text) -&gt; (Integer -&gt; [Char]) -&gt; Integer -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Text) -&gt; Integer -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576941"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>      </span><span class="annot"><span class="annottext">BuiltinResult ByteString
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-comment">-- Check that the requested length does not exceed the limit.  *NB*: if we remove the limit we'll</span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-comment">-- still have to make sure that the length fits into an Int.</span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576940"><span class="hs-identifier hs-var">lengthArg</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringMaximumOutputLength"><span class="hs-identifier hs-var">integerToByteStringMaximumOutputLength</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-67"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ())
-&gt; ([Char] -&gt; Text) -&gt; [Char] -&gt; BuiltinResult ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; BuiltinResult ()) -&gt; [Char] -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;integerToByteString: requested length is too long (maximum is &quot;</span></span><span>
</span><span id="line-68"></span><span>               </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; [Char]) -&gt; Integer -&gt; [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringMaximumOutputLength"><span class="hs-identifier hs-var">integerToByteStringMaximumOutputLength</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>               </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; bytes)&quot;</span></span><span>
</span><span id="line-70"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Length requested: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Text) -&gt; (Integer -&gt; [Char]) -&gt; Integer -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Text) -&gt; Integer -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576940"><span class="hs-identifier hs-var">lengthArg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>      </span><span class="annot"><span class="annottext">BuiltinResult ByteString
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-comment">-- If the requested length is zero (ie, an explicit output size is not</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-comment">-- specified) we still have to make sure that the output won't exceed the size</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-comment">-- limit.  If the requested length is nonzero and less than the limit,</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-comment">-- integerToByteString checks that the input fits.</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576940"><span class="hs-identifier hs-var">lengthArg</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-comment">-- integerLog2 n is one less than the number of significant bits in n</span><span>
</span><span id="line-77"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Int
</span><a href="PlutusCore.Bitwise.Convert.html#integerLog2"><span class="hs-identifier hs-var">integerLog2</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576941"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringMaximumOutputLength"><span class="hs-identifier hs-var">integerToByteStringMaximumOutputLength</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681576952"><span class="annot"><span class="annottext">bytesRequiredFor :: Integer -&gt; Int
</span><a href="#local-6989586621681576952"><span class="hs-identifier hs-var hs-var">bytesRequiredFor</span></a></span></span><span> </span><span id="local-6989586621681576953"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576953"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Int
</span><a href="PlutusCore.Bitwise.Convert.html#integerLog2"><span class="hs-identifier hs-var">integerLog2</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576953"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#div"><span class="hs-operator hs-var">`div`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-79"></span><span>        </span><span class="hs-comment">-- ^ This gives 1 instead of 0 for n=0, but we'll never get that.</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ())
-&gt; ([Char] -&gt; Text) -&gt; [Char] -&gt; BuiltinResult ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; BuiltinResult ()) -&gt; [Char] -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;integerToByteString: input too long (maximum is 2^&quot;</span></span><span>
</span><span id="line-82"></span><span>               </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="PlutusCore.Bitwise.Convert.html#integerToByteStringMaximumOutputLength"><span class="hs-identifier hs-var">integerToByteStringMaximumOutputLength</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>               </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;-1)&quot;</span></span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Length required: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Text) -&gt; (Int -&gt; [Char]) -&gt; Int -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Text) -&gt; Int -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int
</span><a href="#local-6989586621681576952"><span class="hs-identifier hs-var">bytesRequiredFor</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576941"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>      </span><span class="annot"><span class="annottext">BuiltinResult ByteString
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681576956"><span class="annot"><span class="annottext">endianness :: ByteOrder
</span><a href="#local-6989586621681576956"><span class="hs-identifier hs-var hs-var">endianness</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ByteOrder
</span><a href="PlutusCore.Bitwise.Convert.html#endiannessArgToByteOrder"><span class="hs-identifier hs-var">endiannessArgToByteOrder</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681576939"><span class="hs-identifier hs-var">endiannessArg</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-comment">-- We use fromIntegral here, despite advice to the contrary in general when defining builtin</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- denotations. This is because, if we've made it this far, we know that overflow or truncation</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-comment">-- are impossible: we've checked that whatever we got given fits inside a (non-negative) Int.</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteOrder
-&gt; Int -&gt; Integer -&gt; Either IntegerToByteStringError ByteString
</span><a href="PlutusCore.Bitwise.Convert.html#integerToByteString"><span class="hs-identifier hs-var">integerToByteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="#local-6989586621681576956"><span class="hs-identifier hs-var">endianness</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576940"><span class="hs-identifier hs-var">lengthArg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576941"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621681576958"><span class="annot"><span class="annottext">IntegerToByteStringError
</span><a href="#local-6989586621681576958"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IntegerToByteStringError
</span><a href="#local-6989586621681576958"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-92"></span><span>        </span><span class="annot"><span class="annottext">IntegerToByteStringError
</span><a href="PlutusCore.Bitwise.Convert.html#NegativeInput"><span class="hs-identifier hs-var">NegativeInput</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;integerToByteString: cannot convert negative Integer&quot;</span></span><span>
</span><span id="line-94"></span><span>          </span><span class="hs-comment">-- This does work proportional to the size of input. However, we're in a failing case</span><span>
</span><span id="line-95"></span><span>          </span><span class="hs-comment">-- anyway, and the user's paid for work proportional to this size in any case.</span><span>
</span><span id="line-96"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Input: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Text) -&gt; (Integer -&gt; [Char]) -&gt; Integer -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Text) -&gt; Integer -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576941"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>          </span><span class="annot"><span class="annottext">BuiltinResult ByteString
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><span class="annottext">IntegerToByteStringError
</span><a href="PlutusCore.Bitwise.Convert.html#NotEnoughDigits"><span class="hs-identifier hs-var">NotEnoughDigits</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;integerToByteString: cannot represent Integer in given number of bytes&quot;</span></span><span>
</span><span id="line-100"></span><span>          </span><span class="hs-comment">-- This does work proportional to the size of input. However, we're in a failing case</span><span>
</span><span id="line-101"></span><span>          </span><span class="hs-comment">-- anyway, and the user's paid for work proportional to this size in any case.</span><span>
</span><span id="line-102"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Input: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Text) -&gt; (Integer -&gt; [Char]) -&gt; Integer -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Text) -&gt; Integer -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576941"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Bytes requested: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Text) -&gt; (Integer -&gt; [Char]) -&gt; Integer -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Text) -&gt; Integer -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576940"><span class="hs-identifier hs-var">lengthArg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>          </span><span class="annot"><span class="annottext">BuiltinResult ByteString
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-105"></span><span>      </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621681576961"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681576961"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; BuiltinResult ByteString
forall a. a -&gt; BuiltinResult a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681576961"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><span class="hs-comment">-- | Wrapper for 'byteStringToInteger' to make it more convenient to define as a builtin.</span></span><span>
</span><span id="line-108"></span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#byteStringToIntegerWrapper"><span class="hs-identifier hs-type">byteStringToIntegerWrapper</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-110"></span><span id="byteStringToIntegerWrapper"><span class="annot"><span class="annottext">byteStringToIntegerWrapper :: Bool -&gt; ByteString -&gt; Integer
</span><a href="PlutusCore.Bitwise.Convert.html#byteStringToIntegerWrapper"><span class="hs-identifier hs-var hs-var">byteStringToIntegerWrapper</span></a></span></span><span> </span><span id="local-6989586621681576962"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681576962"><span class="hs-identifier hs-var">statedEndiannessArg</span></a></span></span><span> </span><span id="local-6989586621681576963"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681576963"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681576964"><span class="annot"><span class="annottext">endianness :: ByteOrder
</span><a href="#local-6989586621681576964"><span class="hs-identifier hs-var hs-var">endianness</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ByteOrder
</span><a href="PlutusCore.Bitwise.Convert.html#endiannessArgToByteOrder"><span class="hs-identifier hs-var">endiannessArgToByteOrder</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681576962"><span class="hs-identifier hs-var">statedEndiannessArg</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">ByteOrder -&gt; ByteString -&gt; Integer
</span><a href="PlutusCore.Bitwise.Convert.html#byteStringToInteger"><span class="hs-identifier hs-var">byteStringToInteger</span></a></span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="#local-6989586621681576964"><span class="hs-identifier hs-var">endianness</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681576963"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><span class="hs-comment">-- | Structured type to help indicate conversion errors.</span></span><span>
</span><span id="line-115"></span><span class="hs-keyword">data</span><span> </span><span id="IntegerToByteStringError"><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#IntegerToByteStringError"><span class="hs-identifier hs-var">IntegerToByteStringError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-116"></span><span>  </span><span id="NegativeInput"><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#NegativeInput"><span class="hs-identifier hs-var">NegativeInput</span></a></span></span><span> </span><span class="hs-glyph">|</span><span>
</span><span id="line-117"></span><span>  </span><span id="NotEnoughDigits"><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#NotEnoughDigits"><span class="hs-identifier hs-var">NotEnoughDigits</span></a></span></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681576966"><span id="local-6989586621681576968"><span class="annot"><span class="annottext">IntegerToByteStringError -&gt; IntegerToByteStringError -&gt; Bool
(IntegerToByteStringError -&gt; IntegerToByteStringError -&gt; Bool)
-&gt; (IntegerToByteStringError -&gt; IntegerToByteStringError -&gt; Bool)
-&gt; Eq IntegerToByteStringError
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: IntegerToByteStringError -&gt; IntegerToByteStringError -&gt; Bool
== :: IntegerToByteStringError -&gt; IntegerToByteStringError -&gt; Bool
$c/= :: IntegerToByteStringError -&gt; IntegerToByteStringError -&gt; Bool
/= :: IntegerToByteStringError -&gt; IntegerToByteStringError -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681576973"><span id="local-6989586621681576975"><span id="local-6989586621681576979"><span class="annot"><span class="annottext">Int -&gt; IntegerToByteStringError -&gt; [Char] -&gt; [Char]
[IntegerToByteStringError] -&gt; [Char] -&gt; [Char]
IntegerToByteStringError -&gt; [Char]
(Int -&gt; IntegerToByteStringError -&gt; [Char] -&gt; [Char])
-&gt; (IntegerToByteStringError -&gt; [Char])
-&gt; ([IntegerToByteStringError] -&gt; [Char] -&gt; [Char])
-&gt; Show IntegerToByteStringError
forall a.
(Int -&gt; a -&gt; [Char] -&gt; [Char])
-&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; [Char] -&gt; [Char]) -&gt; Show a
$cshowsPrec :: Int -&gt; IntegerToByteStringError -&gt; [Char] -&gt; [Char]
showsPrec :: Int -&gt; IntegerToByteStringError -&gt; [Char] -&gt; [Char]
$cshow :: IntegerToByteStringError -&gt; [Char]
show :: IntegerToByteStringError -&gt; [Char]
$cshowList :: [IntegerToByteStringError] -&gt; [Char] -&gt; [Char]
showList :: [IntegerToByteStringError] -&gt; [Char] -&gt; [Char]
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | Conversion from 'Integer' to 'ByteString', as per</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- [CIP-0087](https://github.com/mlabs-haskell/CIPs/tree/koz/to-from-bytestring/CIP-XXXX).</span><span>
</span><span id="line-122"></span><span class="hs-comment">--</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- For performance and clarity, the endianness argument uses</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- 'ByteOrder', and the length argument is an 'Int'.</span><span>
</span><span id="line-125"></span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#integerToByteString"><span class="hs-identifier hs-type">integerToByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#ByteOrder"><span class="hs-identifier hs-type">ByteOrder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#IntegerToByteStringError"><span class="hs-identifier hs-type">IntegerToByteStringError</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-126"></span><span id="integerToByteString"><span class="annot"><span class="annottext">integerToByteString :: ByteOrder
-&gt; Int -&gt; Integer -&gt; Either IntegerToByteStringError ByteString
</span><a href="PlutusCore.Bitwise.Convert.html#integerToByteString"><span class="hs-identifier hs-var hs-var">integerToByteString</span></a></span></span><span> </span><span id="local-6989586621681576982"><span class="annot"><span class="annottext">ByteOrder
</span><a href="#local-6989586621681576982"><span class="hs-identifier hs-var">requestedByteOrder</span></a></span></span><span> </span><span id="local-6989586621681576983"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span></span><span> </span><span id="local-6989586621681576984"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576984"><span class="hs-identifier hs-var">input</span></a></span></span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576984"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntegerToByteStringError
-&gt; Either IntegerToByteStringError ByteString
forall a b. a -&gt; Either a b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">IntegerToByteStringError
</span><a href="PlutusCore.Bitwise.Convert.html#NegativeInput"><span class="hs-identifier hs-var">NegativeInput</span></a></span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576984"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either IntegerToByteStringError ByteString
forall a b. b -&gt; Either a b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Either IntegerToByteStringError ByteString)
-&gt; (Word8 -&gt; ByteString)
-&gt; Word8
-&gt; Either IntegerToByteStringError ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; Either IntegerToByteStringError ByteString)
-&gt; Word8 -&gt; Either IntegerToByteStringError ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x00</span></span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-comment">-- We use manual specialization to ensure as few branches in loop bodies as</span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-comment">-- we can. See Note [Manual specialization] for details.</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either IntegerToByteStringError ByteString
forall a b. b -&gt; Either a b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Either IntegerToByteStringError ByteString)
-&gt; (Builder -&gt; ByteString)
-&gt; Builder
-&gt; Either IntegerToByteStringError ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; ByteString
</span><span class="hs-identifier hs-var">Builder.builderBytes</span></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; Either IntegerToByteStringError ByteString)
-&gt; Builder -&gt; Either IntegerToByteStringError ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="#local-6989586621681576982"><span class="hs-identifier hs-var">requestedByteOrder</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-132"></span><span>      </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#LittleEndian"><span class="hs-identifier hs-var">LittleEndian</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Integer -&gt; Builder
</span><a href="#local-6989586621681576987"><span class="hs-identifier hs-var">goLENoLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
forall a. Monoid a =&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576984"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-133"></span><span>      </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#BigEndian"><span class="hs-identifier hs-var">BigEndian</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Integer -&gt; Builder
</span><a href="#local-6989586621681576988"><span class="hs-identifier hs-var">goBENoLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
forall a. Monoid a =&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576984"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681576991"><span class="annot"><span class="annottext">result :: Maybe Builder
</span><a href="#local-6989586621681576991"><span class="hs-identifier hs-var hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="#local-6989586621681576982"><span class="hs-identifier hs-var">requestedByteOrder</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-136"></span><span>                    </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#LittleEndian"><span class="hs-identifier hs-var">LittleEndian</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Integer -&gt; Maybe Builder
</span><a href="#local-6989586621681576992"><span class="hs-identifier hs-var">goLELimit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
forall a. Monoid a =&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576984"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-137"></span><span>                    </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#BigEndian"><span class="hs-identifier hs-var">BigEndian</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Integer -&gt; Maybe Builder
</span><a href="#local-6989586621681576993"><span class="hs-identifier hs-var">goBELimit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
forall a. Monoid a =&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576984"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Builder
</span><a href="#local-6989586621681576991"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="annottext">Maybe Builder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntegerToByteStringError
-&gt; Either IntegerToByteStringError ByteString
forall a b. a -&gt; Either a b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">IntegerToByteStringError
</span><a href="PlutusCore.Bitwise.Convert.html#NotEnoughDigits"><span class="hs-identifier hs-var">NotEnoughDigits</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681576994"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681576994"><span class="hs-identifier hs-var">b</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either IntegerToByteStringError ByteString
forall a b. b -&gt; Either a b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Either IntegerToByteStringError ByteString)
-&gt; (Builder -&gt; ByteString)
-&gt; Builder
-&gt; Either IntegerToByteStringError ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; ByteString
</span><span class="hs-identifier hs-var">Builder.builderBytes</span></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; Either IntegerToByteStringError ByteString)
-&gt; Builder -&gt; Either IntegerToByteStringError ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681576994"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><a href="#local-6989586621681576992"><span class="hs-identifier hs-type">goLELimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621681576992"><span class="annot"><span class="annottext">goLELimit :: Builder -&gt; Integer -&gt; Maybe Builder
</span><a href="#local-6989586621681576992"><span class="hs-identifier hs-var hs-var">goLELimit</span></a></span></span><span> </span><span id="local-6989586621681576995"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681576995"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681576996"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576996"><span class="hs-identifier hs-var">remaining</span></a></span></span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576996"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Maybe Builder
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; Maybe Builder) -&gt; Builder -&gt; Maybe Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder
</span><a href="#local-6989586621681576997"><span class="hs-identifier hs-var">padLE</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681576995"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>          </span><span class="hs-comment">-- builderLength is constant time, so we don't track the length ourselves</span><span>
</span><span id="line-147"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; Int
</span><span class="hs-identifier hs-var">Builder.builderLength</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681576995"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>          </span><span class="hs-comment">-- This allows extracting eight digits at once. See Note [Loop sectioning] for details on</span><span>
</span><span id="line-149"></span><span>          </span><span class="hs-comment">-- why we do this. We also duplicate this code in several places: see Note [Manual</span><span>
</span><span id="line-150"></span><span>          </span><span class="hs-comment">-- specialization] for why.</span><span>
</span><span id="line-151"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-152"></span><span>          </span><span class="hs-comment">-- The code is basically equivalent to remaining `quotRem` 2^64, but more efficient. This</span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-comment">-- is for two reasons: firstly, GHC does not optimize divisions into shifts for Integer</span><span>
</span><span id="line-154"></span><span>          </span><span class="hs-comment">-- (even if the divisor is constant), and secondly, the pair generated by `quotRem` costs</span><span>
</span><span id="line-155"></span><span>          </span><span class="hs-comment">-- us as much as 15% peformance, and GHC seems unable to eliminate it. Thus, we have to do</span><span>
</span><span id="line-156"></span><span>          </span><span class="hs-comment">-- it like this instead.</span><span>
</span><span id="line-157"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577001"><span class="annot"><span class="annottext">newRemaining :: Integer
</span><a href="#local-6989586621681577001"><span class="hs-identifier hs-var hs-var">newRemaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576996"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">64</span></span><span>
</span><span id="line-158"></span><span>          </span><span class="hs-comment">-- Given that remaining must be non-negative, fromInteger here effectively truncates to a</span><span>
</span><span id="line-159"></span><span>          </span><span class="hs-comment">-- Word64, by retaining only the least-significant 8 bytes.</span><span>
</span><span id="line-160"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577003"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577003"><span class="hs-identifier hs-var">digitGroup</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Word64
forall a. Num a =&gt; Integer -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#fromInteger"><span class="hs-identifier hs-var">fromInteger</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681576996"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-161"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577001"><span class="hs-identifier hs-var">newRemaining</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-162"></span><span>            </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Word64 -&gt; Maybe Builder
</span><a href="#local-6989586621681577004"><span class="hs-identifier hs-var">finishLELimit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681576995"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577003"><span class="hs-identifier hs-var">digitGroup</span></a></span><span>
</span><span id="line-163"></span><span>            </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Integer -&gt; Maybe Builder
</span><a href="#local-6989586621681576992"><span class="hs-identifier hs-var">goLELimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681576995"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Builder
forall a. Storable a =&gt; a -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.storable</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577003"><span class="hs-identifier hs-var">digitGroup</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577001"><span class="hs-identifier hs-var">newRemaining</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><a href="#local-6989586621681577004"><span class="hs-identifier hs-type">finishLELimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-165"></span><span>    </span><span id="local-6989586621681577004"><span class="annot"><span class="annottext">finishLELimit :: Builder -&gt; Word64 -&gt; Maybe Builder
</span><a href="#local-6989586621681577004"><span class="hs-identifier hs-var hs-var">finishLELimit</span></a></span></span><span> </span><span id="local-6989586621681577006"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577006"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577007"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577007"><span class="hs-identifier hs-var">remaining</span></a></span></span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577007"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Maybe Builder
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; Maybe Builder) -&gt; Builder -&gt; Maybe Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder
</span><a href="#local-6989586621681576997"><span class="hs-identifier hs-var">padLE</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577006"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; Int
</span><span class="hs-identifier hs-var">Builder.builderLength</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577006"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>          </span><span class="hs-comment">-- This is equivalent to 'remaining `quotRem` 256' followed by a conversion of the</span><span>
</span><span id="line-170"></span><span>          </span><span class="hs-comment">-- remainder, but faster. This is similar to the larger example above, and we do it for</span><span>
</span><span id="line-171"></span><span>          </span><span class="hs-comment">-- the same reasons.</span><span>
</span><span id="line-172"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577009"><span class="annot"><span class="annottext">newRemaining :: Word64
</span><a href="#local-6989586621681577009"><span class="hs-identifier hs-var hs-var">newRemaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577007"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-173"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577013"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681577013"><span class="hs-identifier hs-var">digit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577007"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-174"></span><span>          </span><span class="annot"><span class="annottext">Builder -&gt; Word64 -&gt; Maybe Builder
</span><a href="#local-6989586621681577004"><span class="hs-identifier hs-var">finishLELimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577006"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.word8</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681577013"><span class="hs-identifier hs-var">digit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577009"><span class="hs-identifier hs-var">newRemaining</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">-- By separating the case where we don't need to concern ourselves with a</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-comment">-- user-specified limit, we can avoid branching needlessly, or doing a</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-comment">-- complex expression check on every loop. See Note [Manual specialization]</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-comment">-- for why this matters.</span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><a href="#local-6989586621681576987"><span class="hs-identifier hs-type">goLENoLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-180"></span><span>    </span><span id="local-6989586621681576987"><span class="annot"><span class="annottext">goLENoLimit :: Builder -&gt; Integer -&gt; Builder
</span><a href="#local-6989586621681576987"><span class="hs-identifier hs-var hs-var">goLENoLimit</span></a></span></span><span> </span><span id="local-6989586621681577015"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577015"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577016"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577016"><span class="hs-identifier hs-var">remaining</span></a></span></span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577016"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577015"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577018"><span class="annot"><span class="annottext">newRemaining :: Integer
</span><a href="#local-6989586621681577018"><span class="hs-identifier hs-var hs-var">newRemaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577016"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">64</span></span><span>
</span><span id="line-183"></span><span>                        </span><span id="local-6989586621681577020"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577020"><span class="hs-identifier hs-var">digitGroup</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Word64
forall a. Num a =&gt; Integer -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#fromInteger"><span class="hs-identifier hs-var">fromInteger</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577016"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-184"></span><span>                      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577018"><span class="hs-identifier hs-var">newRemaining</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-185"></span><span>                        </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Word64 -&gt; Builder
</span><a href="#local-6989586621681577021"><span class="hs-identifier hs-var">finishLENoLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577015"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577020"><span class="hs-identifier hs-var">digitGroup</span></a></span><span>
</span><span id="line-186"></span><span>                        </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Integer -&gt; Builder
</span><a href="#local-6989586621681576987"><span class="hs-identifier hs-var">goLENoLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577015"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Builder
forall a. Storable a =&gt; a -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.storable</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577020"><span class="hs-identifier hs-var">digitGroup</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577018"><span class="hs-identifier hs-var">newRemaining</span></a></span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><a href="#local-6989586621681577021"><span class="hs-identifier hs-type">finishLENoLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621681577021"><span class="annot"><span class="annottext">finishLENoLimit :: Builder -&gt; Word64 -&gt; Builder
</span><a href="#local-6989586621681577021"><span class="hs-identifier hs-var hs-var">finishLENoLimit</span></a></span></span><span> </span><span id="local-6989586621681577022"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577022"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577023"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577023"><span class="hs-identifier hs-var">remaining</span></a></span></span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577023"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577022"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577025"><span class="annot"><span class="annottext">newRemaining :: Word64
</span><a href="#local-6989586621681577025"><span class="hs-identifier hs-var hs-var">newRemaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577023"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-192"></span><span>              </span><span id="local-6989586621681577028"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681577028"><span class="hs-identifier hs-var">digit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577023"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-193"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Word64 -&gt; Builder
</span><a href="#local-6989586621681577021"><span class="hs-identifier hs-var">finishLENoLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577022"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.word8</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681577028"><span class="hs-identifier hs-var">digit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577025"><span class="hs-identifier hs-var">newRemaining</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><a href="#local-6989586621681576997"><span class="hs-identifier hs-type">padLE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621681576997"><span class="annot"><span class="annottext">padLE :: Builder -&gt; Builder
</span><a href="#local-6989586621681576997"><span class="hs-identifier hs-var hs-var">padLE</span></a></span></span><span> </span><span id="local-6989586621681577029"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577029"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577031"><span class="annot"><span class="annottext">paddingLength :: Int
</span><a href="#local-6989586621681577031"><span class="hs-identifier hs-var hs-var">paddingLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Int
</span><span class="hs-identifier hs-var">Builder.builderLength</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577029"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-196"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577029"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.bytes</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577031"><span class="hs-identifier hs-var">paddingLength</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x0</span></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-comment">-- We manually specialize the big-endian case: see Note [Manual specialization] for why.</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><a href="#local-6989586621681576993"><span class="hs-identifier hs-type">goBELimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-199"></span><span>    </span><span id="local-6989586621681576993"><span class="annot"><span class="annottext">goBELimit :: Builder -&gt; Integer -&gt; Maybe Builder
</span><a href="#local-6989586621681576993"><span class="hs-identifier hs-var hs-var">goBELimit</span></a></span></span><span> </span><span id="local-6989586621681577033"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577033"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577034"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577034"><span class="hs-identifier hs-var">remaining</span></a></span></span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577034"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Maybe Builder
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; Maybe Builder) -&gt; Builder -&gt; Maybe Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder
</span><a href="#local-6989586621681577035"><span class="hs-identifier hs-var">padBE</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577033"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-201"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; Int
</span><span class="hs-identifier hs-var">Builder.builderLength</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577033"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577037"><span class="annot"><span class="annottext">newRemaining :: Integer
</span><a href="#local-6989586621681577037"><span class="hs-identifier hs-var hs-var">newRemaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577034"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">64</span></span><span>
</span><span id="line-204"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577039"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577039"><span class="hs-identifier hs-var">digitGroup</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Word64
forall a. Num a =&gt; Integer -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#fromInteger"><span class="hs-identifier hs-var">fromInteger</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577034"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-205"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577037"><span class="hs-identifier hs-var">newRemaining</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-206"></span><span>            </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Word64 -&gt; Maybe Builder
</span><a href="#local-6989586621681577040"><span class="hs-identifier hs-var">finishBELimit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577033"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577039"><span class="hs-identifier hs-var">digitGroup</span></a></span><span>
</span><span id="line-207"></span><span>            </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Integer -&gt; Maybe Builder
</span><a href="#local-6989586621681576993"><span class="hs-identifier hs-var">goBELimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.word64BE</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577039"><span class="hs-identifier hs-var">digitGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577033"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577037"><span class="hs-identifier hs-var">newRemaining</span></a></span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><a href="#local-6989586621681577040"><span class="hs-identifier hs-type">finishBELimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621681577040"><span class="annot"><span class="annottext">finishBELimit :: Builder -&gt; Word64 -&gt; Maybe Builder
</span><a href="#local-6989586621681577040"><span class="hs-identifier hs-var hs-var">finishBELimit</span></a></span></span><span> </span><span id="local-6989586621681577042"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577042"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577043"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577043"><span class="hs-identifier hs-var">remaining</span></a></span></span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577043"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Maybe Builder
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; Maybe Builder) -&gt; Builder -&gt; Maybe Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder
</span><a href="#local-6989586621681577035"><span class="hs-identifier hs-var">padBE</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577042"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; Int
</span><span class="hs-identifier hs-var">Builder.builderLength</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577042"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577045"><span class="annot"><span class="annottext">newRemaining :: Word64
</span><a href="#local-6989586621681577045"><span class="hs-identifier hs-var hs-var">newRemaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577043"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-214"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577048"><span class="annot"><span class="annottext">digit :: Word8
</span><a href="#local-6989586621681577048"><span class="hs-identifier hs-var hs-var">digit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577043"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-215"></span><span>          </span><span class="annot"><span class="annottext">Builder -&gt; Word64 -&gt; Maybe Builder
</span><a href="#local-6989586621681577040"><span class="hs-identifier hs-var">finishBELimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.word8</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681577048"><span class="hs-identifier hs-var">digit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577042"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577045"><span class="hs-identifier hs-var">newRemaining</span></a></span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><a href="#local-6989586621681576988"><span class="hs-identifier hs-type">goBENoLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621681576988"><span class="annot"><span class="annottext">goBENoLimit :: Builder -&gt; Integer -&gt; Builder
</span><a href="#local-6989586621681576988"><span class="hs-identifier hs-var hs-var">goBENoLimit</span></a></span></span><span> </span><span id="local-6989586621681577049"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577049"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577050"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577050"><span class="hs-identifier hs-var">remaining</span></a></span></span><span>
</span><span id="line-218"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577050"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577049"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-219"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577052"><span class="annot"><span class="annottext">newRemaining :: Integer
</span><a href="#local-6989586621681577052"><span class="hs-identifier hs-var hs-var">newRemaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577050"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">64</span></span><span>
</span><span id="line-220"></span><span>                        </span><span id="local-6989586621681577054"><span class="annot"><span class="annottext">digitGroup :: Word64
</span><a href="#local-6989586621681577054"><span class="hs-identifier hs-var hs-var">digitGroup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Word64
forall a. Num a =&gt; Integer -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#fromInteger"><span class="hs-identifier hs-var">fromInteger</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577050"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-221"></span><span>                      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577052"><span class="hs-identifier hs-var">newRemaining</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-222"></span><span>                        </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Word64 -&gt; Builder
</span><a href="#local-6989586621681577055"><span class="hs-identifier hs-var">finishBENoLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577049"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577054"><span class="hs-identifier hs-var">digitGroup</span></a></span><span>
</span><span id="line-223"></span><span>                        </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Integer -&gt; Builder
</span><a href="#local-6989586621681576988"><span class="hs-identifier hs-var">goBENoLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.word64BE</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577054"><span class="hs-identifier hs-var">digitGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577049"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577052"><span class="hs-identifier hs-var">newRemaining</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><a href="#local-6989586621681577055"><span class="hs-identifier hs-type">finishBENoLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621681577055"><span class="annot"><span class="annottext">finishBENoLimit :: Builder -&gt; Word64 -&gt; Builder
</span><a href="#local-6989586621681577055"><span class="hs-identifier hs-var hs-var">finishBENoLimit</span></a></span></span><span> </span><span id="local-6989586621681577056"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577056"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577057"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577057"><span class="hs-identifier hs-var">remaining</span></a></span></span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577057"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577056"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-227"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577059"><span class="annot"><span class="annottext">newRemaining :: Word64
</span><a href="#local-6989586621681577059"><span class="hs-identifier hs-var hs-var">newRemaining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577057"><span class="hs-identifier hs-var">remaining</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-228"></span><span>                        </span><span id="local-6989586621681577062"><span class="annot"><span class="annottext">digit :: Word8
</span><a href="#local-6989586621681577062"><span class="hs-identifier hs-var hs-var">digit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577057"><span class="hs-identifier hs-var">remaining</span></a></span><span>
</span><span id="line-229"></span><span>                      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Word64 -&gt; Builder
</span><a href="#local-6989586621681577055"><span class="hs-identifier hs-var">finishBENoLimit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.word8</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681577062"><span class="hs-identifier hs-var">digit</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577056"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577059"><span class="hs-identifier hs-var">newRemaining</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><a href="#local-6989586621681577035"><span class="hs-identifier hs-type">padBE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-231"></span><span>    </span><span id="local-6989586621681577035"><span class="annot"><span class="annottext">padBE :: Builder -&gt; Builder
</span><a href="#local-6989586621681577035"><span class="hs-identifier hs-var hs-var">padBE</span></a></span></span><span> </span><span id="local-6989586621681577063"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577063"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577065"><span class="annot"><span class="annottext">paddingLength :: Int
</span><a href="#local-6989586621681577065"><span class="hs-identifier hs-var hs-var">paddingLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681576983"><span class="hs-identifier hs-var">requestedLength</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Int
</span><span class="hs-identifier hs-var">Builder.builderLength</span></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577063"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-232"></span><span>      </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><span class="hs-identifier hs-var">Builder.bytes</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577065"><span class="hs-identifier hs-var">paddingLength</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621681577063"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- | Conversion from 'ByteString' to 'Integer', as per</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- [CIP-0087](https://github.com/mlabs-haskell/CIPs/tree/koz/to-from-bytestring/CIP-XXXX).</span><span>
</span><span id="line-236"></span><span class="hs-comment">--</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- For clarity, the stated endianness argument uses 'ByteOrder'.</span><span>
</span><span id="line-238"></span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#byteStringToInteger"><span class="hs-identifier hs-type">byteStringToInteger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#ByteOrder"><span class="hs-identifier hs-type">ByteOrder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-comment">-- We use manual specialization to ensure as few branches in loop bodies as we can. See Note</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-comment">-- [Manual specialization] for details.</span><span>
</span><span id="line-241"></span><span id="byteStringToInteger"><span class="annot"><span class="annottext">byteStringToInteger :: ByteOrder -&gt; ByteString -&gt; Integer
</span><a href="PlutusCore.Bitwise.Convert.html#byteStringToInteger"><span class="hs-identifier hs-var hs-var">byteStringToInteger</span></a></span></span><span> </span><span id="local-6989586621681577066"><span class="annot"><span class="annottext">ByteOrder
</span><a href="#local-6989586621681577066"><span class="hs-identifier hs-var">statedByteOrder</span></a></span></span><span> </span><span id="local-6989586621681577067"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="#local-6989586621681577066"><span class="hs-identifier hs-var">statedByteOrder</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-comment">-- Since padding bytes in the most-significant-last representation go at</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-comment">-- the end of the input, we can skip decoding them, as they won't affect</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-comment">-- the result in any way.</span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#LittleEndian"><span class="hs-identifier hs-var">LittleEndian</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; Bool) -&gt; ByteString -&gt; Maybe Int
</span><span class="hs-identifier hs-var">BS.findIndexEnd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x00</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-246"></span><span>      </span><span class="hs-comment">-- If there are no nonzero bytes, it must be zero.</span><span>
</span><span id="line-247"></span><span>      </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-248"></span><span>      </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681577070"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577070"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577071"><span class="hs-identifier hs-var">goLE</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577070"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-comment">-- Since padding bytes in the most-significant-first representation go at</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-comment">-- the beginning of the input, we can skip decoding them, as they won't</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- affect the result in any way.</span><span>
</span><span id="line-252"></span><span>    </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#BigEndian"><span class="hs-identifier hs-var">BigEndian</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; Bool) -&gt; ByteString -&gt; Maybe Int
</span><span class="hs-identifier hs-var">BS.findIndex</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x00</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-253"></span><span>      </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-254"></span><span>      </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681577073"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577073"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577074"><span class="hs-identifier hs-var">goBE</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577073"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-comment">-- Like with toByteString, we use loop sectioning to decode eight digits at once. See Note [Loop</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-comment">-- sectioning] for why we do this.</span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><a href="#local-6989586621681577071"><span class="hs-identifier hs-type">goLE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621681577071"><span class="annot"><span class="annottext">goLE :: Integer -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577071"><span class="hs-identifier hs-var hs-var">goLE</span></a></span></span><span> </span><span id="local-6989586621681577076"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577076"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577077"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577077"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621681577078"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577078"><span class="hs-identifier hs-var">ix</span></a></span></span><span>
</span><span id="line-260"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577078"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577077"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577080"><span class="annot"><span class="annottext">digitGroup :: Word64
</span><a href="#local-6989586621681577080"><span class="hs-identifier hs-var hs-var">digitGroup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
</span><a href="#local-6989586621681577081"><span class="hs-identifier hs-var">read64LE</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577078"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-262"></span><span>              </span><span class="hs-comment">-- Same as ix * 8, but faster. GHC might already do this optimization, but we may as</span><span>
</span><span id="line-263"></span><span>              </span><span class="hs-comment">-- well be sure.</span><span>
</span><span id="line-264"></span><span>              </span><span id="local-6989586621681577084"><span class="annot"><span class="annottext">shift :: Int
</span><a href="#local-6989586621681577084"><span class="hs-identifier hs-var hs-var">shift</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577078"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span>
</span><span id="line-265"></span><span>              </span><span id="local-6989586621681577087"><span class="annot"><span class="annottext">newIx :: Int
</span><a href="#local-6989586621681577087"><span class="hs-identifier hs-var hs-var">newIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577078"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-266"></span><span>              </span><span class="hs-comment">-- We use unsafeShiftL to move a group of eight digits into the right position in</span><span>
</span><span id="line-267"></span><span>              </span><span class="hs-comment">-- the result, then combine with the accumulator. This is equivalent to a</span><span>
</span><span id="line-268"></span><span>              </span><span class="hs-comment">-- multiplication by 2^64*k, but significantly faster, as GHC doesn't optimize</span><span>
</span><span id="line-269"></span><span>              </span><span class="hs-comment">-- such multiplications into shifts for Integers.</span><span>
</span><span id="line-270"></span><span>              </span><span id="local-6989586621681577092"><span class="annot"><span class="annottext">newAcc :: Integer
</span><a href="#local-6989586621681577092"><span class="hs-identifier hs-var hs-var">newAcc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577076"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577080"><span class="hs-identifier hs-var">digitGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577084"><span class="hs-identifier hs-var">shift</span></a></span><span>
</span><span id="line-271"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577071"><span class="hs-identifier hs-var">goLE</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577092"><span class="hs-identifier hs-var">newAcc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577077"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577087"><span class="hs-identifier hs-var">newIx</span></a></span><span>
</span><span id="line-272"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577093"><span class="hs-identifier hs-var">finishLE</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577076"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577077"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577078"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><a href="#local-6989586621681577093"><span class="hs-identifier hs-type">finishLE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621681577093"><span class="annot"><span class="annottext">finishLE :: Integer -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577093"><span class="hs-identifier hs-var hs-var">finishLE</span></a></span></span><span> </span><span id="local-6989586621681577094"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577094"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577095"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577095"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621681577096"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577096"><span class="hs-identifier hs-var">ix</span></a></span></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577096"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577095"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577094"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-277"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577099"><span class="annot"><span class="annottext">digit :: Word8
</span><a href="#local-6989586621681577099"><span class="hs-identifier hs-var hs-var">digit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577096"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-278"></span><span>              </span><span id="local-6989586621681577102"><span class="annot"><span class="annottext">shift :: Int
</span><a href="#local-6989586621681577102"><span class="hs-identifier hs-var hs-var">shift</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577096"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span>
</span><span id="line-279"></span><span>              </span><span id="local-6989586621681577105"><span class="annot"><span class="annottext">newIx :: Int
</span><a href="#local-6989586621681577105"><span class="hs-identifier hs-var hs-var">newIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577096"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-280"></span><span>              </span><span class="hs-comment">-- Similarly to before, we use unsafeShiftL to move a single digit into the right</span><span>
</span><span id="line-281"></span><span>              </span><span class="hs-comment">-- position in the result.</span><span>
</span><span id="line-282"></span><span>              </span><span id="local-6989586621681577110"><span class="annot"><span class="annottext">newAcc :: Integer
</span><a href="#local-6989586621681577110"><span class="hs-identifier hs-var hs-var">newAcc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577094"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681577099"><span class="hs-identifier hs-var">digit</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577102"><span class="hs-identifier hs-var">shift</span></a></span><span>
</span><span id="line-283"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577093"><span class="hs-identifier hs-var">finishLE</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577110"><span class="hs-identifier hs-var">newAcc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577095"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577105"><span class="hs-identifier hs-var">newIx</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-comment">-- Technically, ByteString does not allow reading of anything bigger than a single byte.</span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-comment">-- However, because ByteStrings are counted arrays, caching already brings in adjacent bytes,</span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-comment">-- which makes fetching them quite cheap. Additionally, GHC appears to optimize this into a</span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-comment">-- block read of 64 bits at once, which saves memory movement. See Note [Superscalarity and</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-comment">-- caching] for details of why this matters.</span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><a href="#local-6989586621681577081"><span class="hs-identifier hs-type">read64LE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span id="local-6989586621681577081"><span class="annot"><span class="annottext">read64LE :: Int -&gt; Word64
</span><a href="#local-6989586621681577081"><span class="hs-identifier hs-var hs-var">read64LE</span></a></span></span><span> </span><span id="local-6989586621681577111"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-291"></span><span>      </span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">16</span></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">24</span></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">40</span></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">6</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">48</span></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577111"><span class="hs-identifier hs-var">startIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">56</span></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">-- We manually specialize the big-endian cases: see Note [Manual specialization] for why.</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-comment">-- In the big-endian case, shifts and indexes change in different ways: indexes start _high_</span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-comment">-- and _reduce_, but shifts start _low_ and rise. This is different to the little-endian case,</span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-comment">-- where both start low and rise. Thus, we track the index and shift separately in the</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-comment">-- big-endian case: it makes the adjustments easier, and doesn't really change anything, as if</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">-- we wanted to compute the shift, we'd have to pass an offset argument anyway.</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><a href="#local-6989586621681577074"><span class="hs-identifier hs-type">goBE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span id="local-6989586621681577074"><span class="annot"><span class="annottext">goBE :: Integer -&gt; Int -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577074"><span class="hs-identifier hs-var hs-var">goBE</span></a></span></span><span> </span><span id="local-6989586621681577112"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577112"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577113"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577113"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621681577114"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577114"><span class="hs-identifier hs-var">shift</span></a></span></span><span> </span><span id="local-6989586621681577115"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577115"><span class="hs-identifier hs-var">ix</span></a></span></span><span>
</span><span id="line-308"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577115"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577113"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577116"><span class="annot"><span class="annottext">digitGroup :: Word64
</span><a href="#local-6989586621681577116"><span class="hs-identifier hs-var hs-var">digitGroup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
</span><a href="#local-6989586621681577117"><span class="hs-identifier hs-var">read64BE</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577115"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-310"></span><span>              </span><span id="local-6989586621681577120"><span class="annot"><span class="annottext">newShift :: Int
</span><a href="#local-6989586621681577120"><span class="hs-identifier hs-var hs-var">newShift</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577114"><span class="hs-identifier hs-var">shift</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">64</span></span><span>
</span><span id="line-311"></span><span>              </span><span id="local-6989586621681577123"><span class="annot"><span class="annottext">newIx :: Int
</span><a href="#local-6989586621681577123"><span class="hs-identifier hs-var hs-var">newIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577115"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-312"></span><span>              </span><span id="local-6989586621681577128"><span class="annot"><span class="annottext">newAcc :: Integer
</span><a href="#local-6989586621681577128"><span class="hs-identifier hs-var hs-var">newAcc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577112"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681577116"><span class="hs-identifier hs-var">digitGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577114"><span class="hs-identifier hs-var">shift</span></a></span><span>
</span><span id="line-313"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577074"><span class="hs-identifier hs-var">goBE</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577128"><span class="hs-identifier hs-var">newAcc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577113"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577120"><span class="hs-identifier hs-var">newShift</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577123"><span class="hs-identifier hs-var">newIx</span></a></span><span>
</span><span id="line-314"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577129"><span class="hs-identifier hs-var">finishBE</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577112"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577113"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577114"><span class="hs-identifier hs-var">shift</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577115"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><a href="#local-6989586621681577129"><span class="hs-identifier hs-type">finishBE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621681577129"><span class="annot"><span class="annottext">finishBE :: Integer -&gt; Int -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577129"><span class="hs-identifier hs-var hs-var">finishBE</span></a></span></span><span> </span><span id="local-6989586621681577130"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577130"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681577131"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577131"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621681577132"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577132"><span class="hs-identifier hs-var">shift</span></a></span></span><span> </span><span id="local-6989586621681577133"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577133"><span class="hs-identifier hs-var">ix</span></a></span></span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577133"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577131"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577130"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-318"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-319"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681577136"><span class="annot"><span class="annottext">digit :: Word8
</span><a href="#local-6989586621681577136"><span class="hs-identifier hs-var hs-var">digit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577133"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-320"></span><span>              </span><span id="local-6989586621681577139"><span class="annot"><span class="annottext">newShift :: Int
</span><a href="#local-6989586621681577139"><span class="hs-identifier hs-var hs-var">newShift</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577132"><span class="hs-identifier hs-var">shift</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-321"></span><span>              </span><span id="local-6989586621681577142"><span class="annot"><span class="annottext">newIx :: Int
</span><a href="#local-6989586621681577142"><span class="hs-identifier hs-var hs-var">newIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577133"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-322"></span><span>              </span><span id="local-6989586621681577147"><span class="annot"><span class="annottext">newAcc :: Integer
</span><a href="#local-6989586621681577147"><span class="hs-identifier hs-var hs-var">newAcc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577130"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681577136"><span class="hs-identifier hs-var">digit</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577132"><span class="hs-identifier hs-var">shift</span></a></span><span>
</span><span id="line-323"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Int -&gt; Int -&gt; Integer
</span><a href="#local-6989586621681577129"><span class="hs-identifier hs-var">finishBE</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681577147"><span class="hs-identifier hs-var">newAcc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577131"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577139"><span class="hs-identifier hs-var">newShift</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577142"><span class="hs-identifier hs-var">newIx</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><a href="#local-6989586621681577117"><span class="hs-identifier hs-type">read64BE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span id="local-6989586621681577117"><span class="annot"><span class="annottext">read64BE :: Int -&gt; Word64
</span><a href="#local-6989586621681577117"><span class="hs-identifier hs-var hs-var">read64BE</span></a></span></span><span> </span><span id="local-6989586621681577148"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">16</span></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">24</span></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">40</span></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">6</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">48</span></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681577067"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681577148"><span class="hs-identifier hs-var">endIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">7</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int -&gt; Word64
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">56</span></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span class="annot"><a href="PlutusCore.Bitwise.Convert.html#endiannessArgToByteOrder"><span class="hs-identifier hs-type">endiannessArgToByteOrder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#ByteOrder"><span class="hs-identifier hs-type">ByteOrder</span></a></span><span>
</span><span id="line-336"></span><span id="endiannessArgToByteOrder"><span class="annot"><span class="annottext">endiannessArgToByteOrder :: Bool -&gt; ByteOrder
</span><a href="PlutusCore.Bitwise.Convert.html#endiannessArgToByteOrder"><span class="hs-identifier hs-var hs-var">endiannessArgToByteOrder</span></a></span></span><span> </span><span id="local-6989586621681577149"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681577149"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681577149"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#BigEndian"><span class="hs-identifier hs-var">BigEndian</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteOrder
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.ByteOrder.html#LittleEndian"><span class="hs-identifier hs-var">LittleEndian</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">{- Note [Manual specialization]
For both integerToByteString and byteStringToInteger, we have to perform very
similar operations, but with small variations:

- Most-significant-first versus most-significant-last (for both)
- Whether we have a size limit or not (for integerToByteString)

Additionally, loop sectioning (see Note [Loop sectioning]) requires us to have
separate 'big-stride' and 'small-stride' operations to ensure universality of
input handling. Lastly, we have several subroutines (digit extraction, for
instance) that may vary in similar ways. In such a case, generalization by
means of abstraction seems like a good idea, as the operations (and
subroutines) vary little.

At the same time, to determine which variation of any given function (or
subroutine) we need, we only have to scrutinize the relevant argument(s) once:
these specifics (such as byte order) don't change during the course of the
operation. Thus, we want to make sure that these checks in the code are _also_
performed only once, ideally at the beginning.

However, if we write such operations naively as so:

&gt; subroutine byteOrder arg1 arg2 = case byteOrder of
&gt;       LittleEndian -&gt; ...
&gt;       BigEndian -&gt; ...

the byteOrder argument will be scrutinized on each call of subroutine. This is
correct in general (as there is no guarantee that the argument will be stable).
Strangely, however, even in a case like this one:

&gt; mainRoutine byteOrder arg1 arg2 = ...
&gt;    where
&gt;       subroutine arg3 = case byteOrder of
&gt;           LittleEndian -&gt; ...
&gt;           BigEndian -&gt; ...

GHC _still_ re-scrutinizes byteOrder in every call of subroutine! This penalty
can be somewhat lessened using a form similar to this:

&gt; mainRoutine byteOrder arg1 arg2 = ...
&gt;     where
&gt;        !subroutine = case byteOrder of
&gt;             LittleEndian -&gt; \arg3 -&gt; ...
&gt;             BigEndian -&gt; \arg3 -&gt; ...

but this is _still_ between 20 and 30% worse than doing something like this:

&gt; mainRoutine byteOrder arg1 arg2 = case byteOrder of
&gt;     LittleEndian -&gt; [code calling subroutineLE where needed]
&gt;     BigEndian -&gt; [code calling subroutineBE where needed]
&gt;     where
&gt;         subroutineLE arg3 = ...
&gt;         subroutineBE arg3 = ...

This form _ensures_ we scrutinize (and branch) only the number of times we have
to, and in a predictable place. Since these are backends for Plutus Core primops,
and performance is thus critical, we choose to use this manually-specialized form
for each combination of relevant arguments. While this is repetitive, and thus
also somewhat error-prone, the performance penalty for not doing this is
unacceptable.
-}</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="hs-comment">{- Note [Loop sectioning]
Both integerToByteString and byteStringToInteger effectively function as loops
over digits (and thus, individual bytes), which either have to be read or
extracted. In particular, this involves trafficking data between memory and
machine registers (both ByteString and Integer are wrappers around counted
arrays), as well as the overhead of looping (involving comparisons and branches).

However, on all architectures of interest (essentially, 64-bit Tier 1),
general-purpose registers (GPRs henceforth) are 64 bits (or 8 bytes).
Furthermore, the primary cost of moving data between memory and registers is
having to overcome the 'memory wall': the exact amount of data being moved
doesn't affect this very much. In addition to this, when we operate on single
bytes, the remaining 56 bits of the GPR holding that data are essentially
'wasted'. In the situation we have (namely, operating over arrays, whose data
is adjacent in memory), we thus get two sources of inefficiency:

* Despite paying the cost for a memory transfer, we transfer only one-eighth
  the data we could; and
* Despite transferring data from memory to registers, we utilize the register
  at only one-eighth capacity.

This essentially means we perform _eight times_ more rotations of the loop,
and memory moves, than we need to!

To avoid this inefficiency, we use a technique known as _loop sectioning_.
Effectively, this turns our homogenous loop (that always operates one byte at
a time) into a heterogenous loop: first, we operate on a larger section (called
a _stride_) until we can no longer do this, and then we finish up using byte
at a time processing. Essentially, when given an input like this:

[ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10 ]

the homogeous byte-at-a-time approach would process it like so:

  _   _   _   _   _   _   _   _   _   _
[ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10 ]

for a total of 10 memory transfers and 10 loop spins, whereas a loop-sectioned
approach with a stride of 8 would instead process like so:

  ______________________________  _   _
[ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10 ]

Giving us only _three_ memory transfers and _three_ loop spins instead. This
effectively reduces our work by a factor of 8. In our cases, this is almost
free, as there is no data processing to be done: all we need to do is copy
from one place to another, essentially.

This technique only benefits us because counted arrays are cache-friendly: see
Note [Superscalarity and caching] for a longer explanation of this and why it
matters.

Further information:

- Tier 1 GHC platform list:
    https://gitlab.haskell.org/ghc/ghc/-/wikis/platforms#tier-1-platforms
- Memory wall:
    https://link.springer.com/referenceworkentry/10.1007/978-0-387-09766-4_234
- Loop sectioning in more detail:
    http://physics.ujep.cz/~zmoravec/prga/main_for/mergedProjects/optaps_for/common/optaps_vec_mine.htm
-}</span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span class="hs-comment">{- Note [Superscalarity and caching]
On modern architectures, in order to process data, it must first be moved from
memory into a register. This operation has some cost (known as the 'memory wall'),
which is largely independent of how much data gets moved (assuming the register
can hold it): moving one byte, or a whole register's worth, costs about the same.
To reduce this cost, CPU manufacturers have introduced _cache hierarchies_,
which are designed to limit the cost of the wall, as long as the data access
matches the cache's optimal usage pattern. Thus, while an idealized view of
the memory hierachy is this:

Registers
---------
Memory

in reality, the view is more like this:

Registers
---------
L1 cache
---------
L2 cache
---------
L3 cache (on some platforms)
---------
Memory

Each 'higher' cache in the hierarchy is smaller, but faster, and when a memory
fetch is requested in code, in addition to moving the requested data to a
register, that data (plus some more) is moved into caches as well. The amount
of data moved into cache (a _cache line_) is typically eight machine words on
modern architectures (and definitely is the case for all Tier 1 GHC platforms):
for the cases concerning Plutus, that is 64 bytes. Therefore, if data we need
soon after a fetch is _physically_ nearby, it won't need to be fetched from
memory: instead, it would come from a cache, which is faster (by a considerable
margin).

To see how this can matter, consider the following ByteString:

[ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10, b11 ]

The ByteString (being a counted array) has all of its data physically adjacent
to each other. Suppose we wanted to fetch the byte at index 1 (second position).
The naive view of what happens is like this:

Registers: [b2] [ ] [ ] .... [ ]
Memory: [ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10, b11 ]

Thus, it would appear that, if we wanted a different position's value, we would
need to fetch from memory again. However, what _actually_ happens is more like this:

Registers: [b2] [ ] [ ] .... [ ]
L1 cache: [ b2, b3, b4, b5, b6, b7, b8, b9, b10, b11 ]
Memory: [ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10, b11 ]

We note that b2, as well as its adjacent elements, were _all_ pulled into the L1
cache. This can only work because all these elements are physically adjacent in
memory. The improvement in performance from this cache use is _very_ non-trivial:
an L1 cache is about 200 times faster than a memory access, and an L2 cache about
20 times faster.

To take further advantage of this, modern CPUs (and all Tier 1 GHC platforms have
this capability) are _superscalar_. To explain what this means, let's consider the
naive view of how CPUs execute instructions: namely, it is one-at-a-time, and
synchronous. While CPUs must give the _appearance_ that they behave this way, in
practice, CPU execution is very much asynchronous: due to the proliferation of ALUs
on a single chip, having twice as many processing units is much cheaper than having
processing units run twice as fast. Thus, if there are no data dependencies
between instructions, CPUs can (and do!) execute them simultaneously, stalling to
await results if a data dependency is detected. This can be done automatically
using Tomasulo's algorithm, which ensures no conflicts with maximum throughput.

Superscalarity interacts well with the cache hierarchy, as it makes data more
easily available for processing, provided there is enough 'work to do', and no
data dependencies. In our situation, most of what we do is data _movement_ from
one memory location to another, which by its very nature lacks any data
dependencies.

Further references:

- Numbers for cache and memory transfers: https://gist.github.com/jboner/2841832
- Superscalarity: https://en.wikipedia.org/wiki/Superscalar_processor
- Tomasulo's algorithm: https://en.wikipedia.org/wiki/Tomasulo%27s_algorithm
-}</span><span>
</span><span id="line-545"></span></pre></body></html>