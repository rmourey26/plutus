<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Defines the type of default machine parameters and a function for creating a value of the type.</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- We keep them separate, because the function unfolds into multiple thousands of lines of Core that</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- we need to be able to visually inspect, hence we dedicate a separate file to it.</span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusCore.Evaluation.Machine.MachineParameters.Default</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Default.html"><span class="hs-identifier">PlutusCore.Default</span></a></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.CostModelInterface</span></a></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudgetingDefaults.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.ExBudgetingDefaults</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.MachineParameters</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.html"><span class="hs-identifier">UntypedPlutusCore.Evaluation.Machine.Cek</span></a></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/GHC.Exts.html"><span class="hs-identifier">GHC.Exts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Magic.html#inline"><span class="hs-identifier">inline</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-comment">-- | 'MachineParameters' instantiated at CEK-machine-specific types and default builtins.</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- Encompasses everything we need for evaluating a UPLC program with default builtins using the CEK</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- machine.</span><span>
</span><span id="line-19"></span><span class="hs-keyword">type</span><span> </span><span id="DefaultMachineParameters"><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.Default.html#DefaultMachineParameters"><span class="hs-identifier hs-var">DefaultMachineParameters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#MachineParameters"><span class="hs-identifier hs-type">MachineParameters</span></a></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCosts"><span class="hs-identifier hs-type">CekMachineCosts</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Default.Builtins.html#DefaultFun"><span class="hs-identifier hs-type">DefaultFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Default.Universe.html#DefaultUni"><span class="hs-identifier hs-type">DefaultUni</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Default.Builtins.html#DefaultFun"><span class="hs-identifier hs-type">DefaultFun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-comment">{- Note [Inlining meanings of builtins]
It's vitally important to inline the 'toBuiltinMeaning' method of a set of built-in functions as
that allows GHC to look under lambdas and completely optimize multiple abstractions away.

There are two ways of doing that: by relying on 'INLINE' pragmas all the way up from the
'ToBuiltinMeaning' instance for the default set of builtins or by ensuring that 'toBuiltinsRuntime'
is compiled efficient by turning it into a one-method class (see
https://github.com/IntersectMBO/plutus/pull/4419 for how that looks like). We chose the former,
because it's simpler. Although it's also less reliable: machine parameters are computed in
multiple places and we need to make sure that benchmarking, cost model calculations and the actual
production path have builtins compiled in the same way, 'cause otherwise performance analysis and
cost predictions can be wrong by a big margin without us knowing. Because of this danger in addition
to putting @INLINE@ pragmas on every relevant definition, we also stick a call to 'inline' at the
call site. We also do not attempt to only compile things efficiently where we need that and instead
inline the meanings of builtins everywhere. Just to be sure.

Note that a combination of @INLINABLE@ + 'inline' does not result in proper inlining for whatever
reason. It has to be @INLINE@ (and we add 'inline' on top of that for some additional reliability
as we did have cases where sticking 'inline' on something that already had @INLINE@ would fix
inlining).
-}</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-comment">-- | Produce a 'DefaultMachineParameters' given the version of the default set of built-in functions</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- and a 'CostModelParams', which gets applied on top of 'defaultCekCostModel'.</span><span>
</span><span id="line-46"></span><span class="hs-comment">--</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- Whenever you need to evaluate UPLC in a performance-sensitive manner (e.g. in the production,</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- for benchmarking, for cost calibration etc), you MUST use this definition for creating a</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- 'DefaultMachineParameters' and not any other. Changing this definition in absolutely any way,</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- however trivial, requires running the benchmarks and making sure that the resulting GHC Core is</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- still sensible. E.g. you switch the order of arguments -- you run the benchmarks and check the</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- Core; you move this definition as-is to a different file -- you run the benchmarks and check the</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- Core; you change how it's exported (implicitly as a part of a whole-module export or explicitly</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- as a single definition) -- you get the idea.</span><span>
</span><span id="line-55"></span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- This function is expensive, so its result needs to be cached if it's going to be used multiple</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- times.</span><span>
</span><span id="line-58"></span><span id="local-6989586621681617282"><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.Default.html#mkMachineParametersFor"><span class="hs-identifier hs-type">mkMachineParametersFor</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyError"><span class="hs-identifier hs-type">CostModelApplyError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681617282"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinSemanticsVariant"><span class="hs-identifier hs-type">BuiltinSemanticsVariant</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Default.Builtins.html#DefaultFun"><span class="hs-identifier hs-type">DefaultFun</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681617282"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.Default.html#DefaultMachineParameters"><span class="hs-identifier hs-type">DefaultMachineParameters</span></a></span></span><span>
</span><span id="line-63"></span><span id="mkMachineParametersFor"><span class="annot"><span class="annottext">mkMachineParametersFor :: forall (m :: * -&gt; *).
MonadError CostModelApplyError m =&gt;
BuiltinSemanticsVariant DefaultFun
-&gt; CostModelParams -&gt; m DefaultMachineParameters
</span><a href="PlutusCore.Evaluation.Machine.MachineParameters.Default.html#mkMachineParametersFor"><span class="hs-identifier hs-var hs-var">mkMachineParametersFor</span></a></span></span><span> </span><span id="local-6989586621681617435"><span class="annot"><span class="annottext">BuiltinSemanticsVariant DefaultFun
</span><a href="#local-6989586621681617435"><span class="hs-identifier hs-var">semvar</span></a></span></span><span> </span><span id="local-6989586621681617436"><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621681617436"><span class="hs-identifier hs-var">newCMP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><span class="annottext">(BuiltinSemanticsVariant DefaultFun
 -&gt; CostModel CekMachineCosts BuiltinCostModel
 -&gt; DefaultMachineParameters)
-&gt; BuiltinSemanticsVariant DefaultFun
-&gt; CostModel CekMachineCosts BuiltinCostModel
-&gt; DefaultMachineParameters
forall a. a -&gt; a
</span><a href="../../../ghc-9.6.4/html/libraries/ghc-prim-0.10.0/src/GHC.Magic.html#inline"><span class="hs-identifier hs-var">inline</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinSemanticsVariant DefaultFun
-&gt; CostModel CekMachineCosts BuiltinCostModel
-&gt; DefaultMachineParameters
forall (uni :: * -&gt; *) fun builtincosts val machinecosts.
(CostingPart uni fun ~ builtincosts, HasMeaningIn uni val,
 ToBuiltinMeaning uni fun) =&gt;
BuiltinSemanticsVariant fun
-&gt; CostModel machinecosts builtincosts
-&gt; MachineParameters machinecosts fun val
</span><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#mkMachineParameters"><span class="hs-identifier hs-var">mkMachineParameters</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinSemanticsVariant DefaultFun
</span><a href="#local-6989586621681617435"><span class="hs-identifier hs-var">semvar</span></a></span><span> </span><span class="annot"><span class="annottext">(CostModel CekMachineCosts BuiltinCostModel
 -&gt; DefaultMachineParameters)
-&gt; m (CostModel CekMachineCosts BuiltinCostModel)
-&gt; m DefaultMachineParameters
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../ghc-9.6.4/html/libraries/base-4.18.2.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-65"></span><span>        </span><span class="annot"><span class="annottext">CostModel CekMachineCosts BuiltinCostModel
-&gt; CostModelParams
-&gt; m (CostModel CekMachineCosts BuiltinCostModel)
forall evaluatorcosts builtincosts (m :: * -&gt; *).
(FromJSON evaluatorcosts, FromJSON builtincosts,
 ToJSON evaluatorcosts, ToJSON builtincosts,
 MonadError CostModelApplyError m) =&gt;
CostModel evaluatorcosts builtincosts
-&gt; CostModelParams -&gt; m (CostModel evaluatorcosts builtincosts)
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applyCostModelParams"><span class="hs-identifier hs-var">applyCostModelParams</span></a></span><span> </span><span class="annot"><span class="annottext">CostModel CekMachineCosts BuiltinCostModel
</span><a href="PlutusCore.Evaluation.Machine.ExBudgetingDefaults.html#defaultCekCostModel"><span class="hs-identifier hs-var">defaultCekCostModel</span></a></span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621681617436"><span class="hs-identifier hs-var">newCMP</span></a></span><span>
</span><span id="line-66"></span><span class="hs-comment">-- Not marking this function with @INLINE@, since at this point everything we wanted to be inlined</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- is inlined and there's zero reason to duplicate thousands and thousands of lines of Core down</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- the line.</span><span>
</span><span id="line-69"></span></pre></body></html>